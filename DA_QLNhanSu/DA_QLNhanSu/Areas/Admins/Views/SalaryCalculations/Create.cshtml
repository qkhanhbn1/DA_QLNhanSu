@model DA_QLNhanSu.Models.SalaryCalculation

@{
    ViewData["Title"] = "Create";
    Layout = "~/Areas/Admins/Views/Shared/_LayoutAdmin.cshtml";
}

<h1>Create</h1>

<h4>Tính lương</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Ide" class="control-label">Tên nhân viên</label>
                <select asp-for="Ide" class="form-control" asp-items="ViewBag.Ide" id="IdeDropdown"></select>
            </div>

            <div class="form-group">
                <label for="Month">Tháng</label>
                <input type="number" id="MonthInput" class="form-control" min="1" max="12" />
            </div>

            <div class="form-group">
                <label for="Year">Năm</label>
                <input type="number" id="YearInput" class="form-control" />
            </div>

            <div class="form-group">
                <label>Số ngày làm trong tháng</label>
                <input type="text" id="Workday" class="form-control" readonly />
            </div>
            <div class="form-group">
                <label asp-for="IdPosition" class="control-label">Chức vụ</label>
                <select asp-for="IdPosition" class="form-control" asp-items="ViewBag.IdPosition" id="IdPositionDropdown" readonly></select>
            </div>
            <div class="form-group">
                <label>Tiền lương hàng ngày</label>
                <input type="text" id="DailyWage" class="form-control" readonly />
            </div>
            @* <div class="form-group">
                <label asp-for="IdOvertime" class="control-label"></label>
                <select asp-for="IdOvertime" class="form-control" asp-items="ViewBag.IdOvertime" id="IdOvertimeDropdown" readonly></select>
            </div> *@
            <div class="form-group">
                <label>Tiền tăng ca</label>
                <input type="text" id="OvertimePay" class="form-control" readonly />
            </div>
            @* <div class="form-group">
                <label asp-for="IdEmployeeallowance" class="control-label"></label>
                <select asp-for="IdEmployeeallowance" class="form-control" asp-items="ViewBag.IdEmployeeallowance" id="IdEmployeeAllowanceDropdown" readonly></select>
            </div> *@
            <div class="form-group">
                <label>Tiền phụ cấp</label>
                <input type="text" id="AllowanceMoney" class="form-control" readonly />
            </div>
            @* <div class="form-group">
                <label asp-for="IdSalaryadvance" class="control-label"></label>
                <select asp-for="IdSalaryadvance" class="form-control" asp-items="ViewBag.IdSalaryadvance" id="IdSalaryAdvanceDropdown" readonly></select>
            </div> *@
            <div class="form-group">
                <label>Tiền ứng lương</label>
                <input type="text" id="AdvanceMoney" class="form-control" readonly />
            </div>
            <div class="form-group">
                <label asp-for="TotalSalary" class="control-label">Tổng tiền</label>
                <input asp-for="TotalSalary" class="form-control" readonly />
                <span asp-validation-for="TotalSalary" class="text-danger"></span>
            </div>
            
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            function fetchData(type, id, targetInput) {
                if (id) {
                    $.ajax({
                        url: '/Admins/SalaryCalculations/GetData',
                        type: 'GET',
                        data: { id: id, type: type },
                        success: function (data) {
                            $(targetInput).val(data.value);
                        },
                        error: function () {
                            alert('Error fetching data. Please try again.');
                            $(targetInput).val('');
                        }
                    });
                } else {
                    $(targetInput).val('');
                }
            }

            // Lấy DailyWage khi thay đổi IdPosition
            $('#IdPositionDropdown').change(function () {
                var selectedId = $(this).val();
                fetchData('dailywage', selectedId, '#DailyWage');
            });

            // Lấy OvertimePay khi thay đổi IdOvertime
            $('#IdOvertimeDropdown').change(function () {
                var selectedId = $(this).val();
                fetchData('overtimepay', selectedId, '#OvertimePay');
            });

            // Lấy Money khi thay đổi IdEmployeeallowance
            $('#IdEmployeeAllowanceDropdown').change(function () {
                var selectedId = $(this).val();
                fetchData('allowancemoney', selectedId, '#AllowanceMoney');
            });

            // Lấy Money khi thay đổi IdSalaryadvance
            $('#IdSalaryAdvanceDropdown').change(function () {
                var selectedId = $(this).val();
                fetchData('advancemoney', selectedId, '#AdvanceMoney');
            });
        });
    </script>

    @* tinh workday *@
    <script>
        $(document).ready(function () {
            function fetchWorkday(ide, month, year) {
                if (ide && month && year) {
                    $.ajax({
                        url: '/Admins/SalaryCalculations/GetWorkday',
                        type: 'GET',
                        data: { ide: ide, month: month, year: year },
                        success: function (data) {
                            $('#Workday').val(data.workday);
                        },
                        error: function () {
                            alert('Workday not found for the given criteria.');
                            $('#Workday').val('');
                        }
                    });
                } else {
                    $('#Workday').val('');
                }
            }

            // Trigger fetch when Ide, Month, or Year changes
            $('#IdeDropdown, #MonthInput, #YearInput').change(function () {
                var ide = $('#IdeDropdown').val();
                var month = $('#MonthInput').val();
                var year = $('#YearInput').val();

                fetchWorkday(ide, month, year);
            });
        });
    </script>

       @*  lay dữ liệu từ Ide nhân viên ---------------------------------------------------------*@
    <script>
        $(document).ready(function () {
            // Khi thay đổi Ide
            $('#IdeDropdown').change(function () {
                var selectedIde = $(this).val();

                if (selectedIde) {
                    // Gọi AJAX để lấy thông tin từ các bảng: Position, Overtime, EmployeeAllowance, và SalaryAdvance
                    $.ajax({
                        url: '/Admins/SalaryCalculations/GetEmployeeDetails',
                        type: 'GET',
                        data: { ide: selectedIde },
                        success: function (data) {
                            // Gán IdPosition vào dropdown hoặc ẩn đi nếu cần
                            $('#IdPositionDropdown').val(data.idPosition);

                            // Gán DailyWage vào input
                            $('#DailyWage').val(data.dailyWage);

                            // Gán OvertimePay vào input
                            $('#OvertimePay').val(data.overtimePay);

                            // Gán AllowanceMoney vào input
                            $('#AllowanceMoney').val(data.allowanceMoney);

                            // Gán AdvanceMoney vào input
                            $('#AdvanceMoney').val(data.advanceMoney);
                        },
                        error: function () {
                            alert('Error fetching data. Please try again.');
                            $('#IdPositionDropdown').val('');
                            $('#DailyWage').val('');
                            $('#OvertimePay').val('');
                            $('#AllowanceMoney').val('');
                            $('#AdvanceMoney').val('');
                        }
                    });
                } else {
                    // Nếu không có Ide, reset tất cả các trường
                    $('#IdPositionDropdown').val('');
                    $('#DailyWage').val('');
                    $('#OvertimePay').val('');
                    $('#AllowanceMoney').val('');
                    $('#AdvanceMoney').val('');
                }
            });
        });
    </script>
    @* //tinh tong tien *@
    <script>
        $(document).ready(function () {
            // Khi thay đổi Ide, Month, Year, tính TotalSalary
            $('#IdeDropdown, #MonthInput, #YearInput').change(function () {
                // Lấy các giá trị
                var ide = $('#IdeDropdown').val();
                var month = $('#MonthInput').val();
                var year = $('#YearInput').val();
                var workday = $('#Workday').val();
                var dailyWage = $('#DailyWage').val();
                var overtimePay = $('#OvertimePay').val();
                var allowanceMoney = $('#AllowanceMoney').val();
                var advanceMoney = $('#AdvanceMoney').val();

                // Kiểm tra các giá trị đã đủ chưa
                if (ide && month && year && workday && dailyWage && overtimePay && allowanceMoney && advanceMoney) {
                    // Tính TotalSalary theo công thức
                    var totalSalary = (parseInt(workday) * parseFloat(dailyWage)) + parseFloat(overtimePay) + parseFloat(allowanceMoney) - parseFloat(advanceMoney);

                    // Gán TotalSalary vào input
                    $('#TotalSalary').val(totalSalary.toFixed(2));
                } else {
                    // Nếu thiếu giá trị, reset TotalSalary
                    $('#TotalSalary').val('');
                }
            });
        });
    </script>

}
